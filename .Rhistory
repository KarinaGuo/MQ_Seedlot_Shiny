"Mq_MLNP_106" = "HWC_106",
"Mq_MLNP_618" = "Cattai_618",
"NSW1214046"  = "NSW1213746"
)
for (i in seq_along(replacements)) {
prediction_gt$NSWID <- gsub(names(replacements)[i], replacements[i], prediction_gt$NSWID)
}
prediction_gt_planted <- left_join(sample_meta_planting, prediction_gt) %>%
filter (!is.na(Prediction)) #Removing those not genotyped or poorly predicted
prediction_gt_planted$UID_numb <- sub(".*_(\\d+)$", "\\1", prediction_gt_planted$NSWID)
prediction_gt_planted$UID <- ifelse(!grepl("Mq", prediction_gt_planted$ID), paste0("Mq_", prediction_gt_planted$ID), prediction_gt_planted$ID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results_UID, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
bin_monit_survey_results_mat_GT <- left_join(bin_monit_survey_results_mat, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
# Chunk 5
survey_results_summed_date_worst <- reg_monit_survey_results %>% group_by(`Myrtle rust worst score`, Site, Date) %>% filter(!is.na(`Myrtle rust worst score`)) %>% summarise (n=n()) %>% complete(Date = max(Date), fill = list(n = 0))
survey_results_summed_date_impact <- reg_monit_survey_results %>% group_by(`Myrtle rust impact score`, Site, Date) %>% filter(!is.na(`Myrtle rust impact score`)) %>% summarise (n=n()) %>% complete(Date = max(Date), fill = list(n = 0))
########## Todo: For the group with Site and max(Date), add a Myrtle rust impact score of 0 if that group does not exist
score_levels <- sort(unique(survey_results_recents$`Myrtle rust worst score`))
colors <- colorRampPalette(c( "forestgreen", "red"))(length(score_levels))
plot_dates_worst <- ggplot(survey_results_summed_date_worst, aes(x=Date, y=n, group=as.factor(`Myrtle rust worst score`), fill=as.factor(`Myrtle rust worst score`),colour=as.factor(`Myrtle rust worst score`))) +
geom_line(linewidth=0.1) +
geom_point(alpha=0.5, size=0.5) +
geom_ribbon(data=survey_results_summed_date_worst, aes(ymin = 0, ymax = n), alpha = 0.2, colour = NA) +
theme_bw() +
geom_vline(data=planting_dates, aes(xintercept=Date), colour='grey70', linetype="dashed", linewidth=0.5) +
scale_fill_manual(values = setNames(colors, score_levels)) +
scale_colour_manual(values = setNames(colors, score_levels)) +
labs(fill="Myrtle rust score", x="Date", y="Total sample count", title="Count of MR worst score across time") +
ggnewscale::new_scale_fill() +
geom_rect(data = season_rects, aes(xmin = as.numeric(season_start), xmax = as.numeric(season_end),  ymin = -Inf, ymax = Inf,  fill = Season), alpha = 0.1, inherit.aes = FALSE) +
scale_fill_manual(values = c("Autumn" = "goldenrod1", "Winter" = "skyblue", "Spring"="palegreen2", Summer="rosybrown1")) +
facet_wrap(~Site) +
guides(colour="none")
plot_dates_impact <- ggplot(survey_results_summed_date_impact, aes(x=Date, y=n, group=as.factor(`Myrtle rust impact score`), fill=as.factor(`Myrtle rust impact score`),colour=as.factor(`Myrtle rust impact score`))) +
geom_point(alpha=0.5, size=0.5) +
geom_line(linewidth=0.1) +
geom_ribbon(data=survey_results_summed_date_impact, aes(ymin = 0, ymax = n), alpha = 0.2, colour = NA) +
theme_bw() +
geom_vline(data=planting_dates, aes(xintercept=Date), colour='grey70', linetype="dashed", linewidth=0.5) +
scale_fill_manual(values = setNames(colors, score_levels)) +
scale_colour_manual(values = setNames(colors, score_levels)) +
ggnewscale::new_scale_fill() +
geom_rect(data = season_rects, aes(xmin = as.numeric(season_start), xmax = as.numeric(season_end),  ymin = -Inf, ymax = Inf,  fill = Season), alpha = 0.1, inherit.aes = FALSE) +
scale_fill_manual(values = c("Autumn" = "goldenrod1", "Winter" = "skyblue", "Spring"="palegreen2", Summer="rosybrown1")) +
facet_wrap(~Site) +
theme(legend.position = "none") +
labs(fill="Myrtle rust score", x="Date", y="Total sample count", title="Count of MR impact score across time")
plot_both <- plot_dates_worst/plot_dates_impact + plot_layout(guides = "collect", axes = "collect")
ggsave(plot_both, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_dates_imp_worst.jpg", width=4000, height=2500, units="px", limitsize=F)
# Chunk 6
score_levels <- sort(unique(survey_results_rm_snapped_meanUID$mean_UID_impact))
colors <- colorRampPalette(c( "forestgreen", "red"))(length(score_levels))
plot_dates_height <- ggplot() +
geom_rect(data = season_rects, aes(xmin = as.numeric(season_start), xmax = as.numeric(season_end),  ymin = -Inf, ymax = Inf,  fill = Season), alpha = 0.1, inherit.aes = FALSE) +
scale_fill_manual(values = c("Autumn" = "goldenrod1", "Winter" = "skyblue", "Spring"="palegreen2", Summer="rosybrown1")) +
ggnewscale::new_scale_fill() +
geom_point(data=survey_results_rm_snapped_meanUID, aes(x=Date, y=`Height (m)`, group=as.factor(mean_UID_impact), colour=mean_UID_impact, fill=mean_UID_impact), alpha=0.2) +
geom_line(data=survey_results_rm_snapped_meanUID, aes(x=Date, y=`Height (m)`, group=UID_numb, colour=mean_UID_impact), stat="smooth", method='lm', linewidth=0.5, se=F, alpha=0.1) +
stat_smooth(data=survey_results_rm_snapped_meanUID, aes(x=Date, y=`Height (m)`, group=as.factor(mean_UID_impact), colour=mean_UID_impact, fill=mean_UID_impact), method='lm', linewidth=0.5, se=T, alpha=0.1) +
theme_bw() +
scale_colour_manual(values = setNames(colors, score_levels)) +
scale_fill_manual(values = setNames(colors, score_levels)) +
labs(colour="Mean individual impact category", x="Date") +
guides(fill='none') +
geom_vline(data=planting_dates, aes(xintercept=Date), colour='grey70', linetype="dashed", linewidth=0.5) +
facet_wrap(~Site)
plot_dates_height
ggsave(plot_dates_height, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_dates_height.jpg", width=3000, height=2000, units="px", limitsize=F)
# Chunk 7
# Final height (most recent) comparisons
final_date=max(survey_results_rm_snapped_meanUID$Month)
Final_height <- survey_results_rm_snapped_meanUID %>%
filter(Month == final_date) %>%
mutate(mean_UID_impact = factor(mean_UID_impact, levels = c("No infection","Low", "Mid", "High")))
score_levels <- sort(unique(Final_height$mean_UID_impact))
colors <- colorRampPalette(c( "forestgreen", "red"))(length(score_levels))
summary(aov(formula = `Height (m)` ~ mean_UID_impact, data=Final_height))
summary(lm(formula = `Height (m)` ~ mean_impact, data=Final_height))
final_height_cat <- ggplot(Final_height, aes(x=mean_UID_impact, y=as.numeric(`Height (m)`), group=as.factor(mean_UID_impact), fill=as.factor(mean_UID_impact))) +
geom_boxplot(alpha=0.4) +
geom_jitter(width=0.2, alpha=0.2) +
theme_bw() +
scale_fill_manual(values = setNames(colors, score_levels))+
labs(y="Height (m)", x="Mean MR impact score") +
facet_wrap(~Site)
final_height_cat
ggsave(final_height_cat, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/final_height_cat.jpg", width=3000, height=2000, units="px", limitsize=F)
final_height_quant <- ggplot(Final_height, aes(x=mean_impact, y=as.numeric(`Height (m)`))) +
geom_point(alpha=0.4) +
theme_bw() +
stat_smooth(method="lm", se=F) +
labs(y="Height (m)", x="Mean MR impact score") +
facet_wrap(~Site)
final_height_quant
## Need to look at 1) Most recent MR incidence, 2) Last and last 2 months of MR incidence
### Load in blups
height_byMR <- reg_prediction_gt_plantingexp_summ %>%
group_by(Site, UID_numb, `(Intercept)`) %>%
mutate(n = n()) %>%
filter(n > 2) %>%
group_by(Site, UID_numb) %>%
arrange(Date, .by_group = TRUE) %>%
summarise(Height_diff = (`Height (m)` - lag(`Height (m)`)),
Season = Season,
BLUP = (`(Intercept)`),
MR_impact_overall = mean(`Myrtle rust impact score`),
MR_date = lag(`Myrtle rust worst score`, n=0),
MR_last_date = lag(`Myrtle rust worst score`, n=1),
MR_last_2date = lag(`Myrtle rust worst score`, n=2),
MR_last_3date = lag(`Myrtle rust worst score`, n=3)) %>%
ungroup()
View(reg_prediction_gt_plantingexp_summ)
prediction_gt
## Generate a summarative score for each individual given different lengths of monitoring
mod <- lmer(`Myrtle rust worst score` ~  factor(Date) + (1|UID), data=reg_monit_survey_results_UID)
ranef_scores <- ranef(mod)$UID; ranef_scores<- rownames_to_column(ranef_scores, var="UID"); colnames(ranef_scores)[2] <- "ranef_int" # random intercepts
individual_effects <- coef(mod)$UID; individual_effects<- rownames_to_column(individual_effects, var="UID") # population adjusted BLUPs; global mean + ranef_int.
rough_summ <- reg_monit_survey_results_mat_GT %>% group_by(UID) %>% summarise (rgh_mean=mean(`Myrtle rust worst score`, na.rm=T))
summ <- left_join(rough_summ, ranef_scores); summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects, by="UID")
# Check
reg_prediction_gt_plantingexp_summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects)
## Compare prediction against blup
# Site split
reg_prediction_gt_plantingexp_comp <- ggplot(reg_prediction_gt_plantingexp_summ, aes(x=Prediction, y=`(Intercept)`)) +
geom_point(alpha=0.1) +
geom_smooth(method = 'lm', colour="grey", linetype="dashed", se=F) +
theme_bw() +
labs (title = "Prediction vs BLUP") +
facet_wrap(~Site)
ggsave(reg_prediction_gt_plantingexp_comp, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/reg_prediction_gt_plantingexp_comp.jpg", width=3500, height=2000, units="px", limitsize=F)
## Difference from worst score rescaled to 0,3 vs predicted
reg_prediction_gt_plantingexp_summ$mrws_rescale <- scales::rescale(reg_prediction_gt_plantingexp_summ$`Myrtle rust worst score`, from = c(0,5), to=c(0,3))
reg_prediction_gt_plantingexp_summ$mrws_rescale_pred_diff <- reg_prediction_gt_plantingexp_summ$mrws_rescale - reg_prediction_gt_plantingexp_summ$Prediction
## Difference over time remade\
# Colour individuals with biggest departure
UID_means <- reg_prediction_gt_plantingexp_summ %>%
group_by(UID) %>%
summarise(mean_diff = mean(mrws_rescale_pred_diff, na.rm = TRUE))
prediction_survey_res_alt <- left_join(reg_prediction_gt_plantingexp_summ, UID_means, by = "UID")
colour_thresh=3
prediction_survey_res_alt$UID_highlight <- ifelse(abs(prediction_survey_res_alt$mean_diff) > colour_thresh, prediction_survey_res_alt$UID, "Other")
colours <- length(unique(prediction_survey_res_alt$UID_highlight)) - 1
## Need to look at 1) Most recent MR incidence, 2) Last and last 2 months of MR incidence
### Load in blups
height_byMR <- reg_prediction_gt_plantingexp_summ %>%
group_by(Site, UID_numb, `(Intercept)`) %>%
mutate(n = n()) %>%
filter(n > 2) %>%
group_by(Site, UID_numb) %>%
arrange(Date, .by_group = TRUE) %>%
summarise(Height_diff = (`Height (m)` - lag(`Height (m)`)),
Season = Season,
BLUP = (`(Intercept)`),
MR_impact_overall = mean(`Myrtle rust impact score`),
MR_date = lag(`Myrtle rust worst score`, n=0),
MR_last_date = lag(`Myrtle rust worst score`, n=1),
MR_last_2date = lag(`Myrtle rust worst score`, n=2),
MR_last_3date = lag(`Myrtle rust worst score`, n=3)) %>%
ungroup()
View(reg_prediction_gt_plantingexp_summ)
View(reg_monit_survey_results_mat_GT)
prediction_gt <- read.csv("~/Uni/Doctorate/Samples/Genotyping/Report-DMela25-10753/Report-DMela25-10753/GP_Out/prediction_gt.csv") %>% dplyr::select(c(Taxa, PEV, Prediction))
colnames(prediction_gt)[1] <- "NSWID"
sample_meta_planting <- read_xlsx("C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Samples/All_samples.xlsx") %>% filter(!is.na(NSWID) & `Genotyping Purpose`=="Planting_experiment") %>% dplyr::select(NSWID, ID)
## Fixing name errors
replacements <- c(
"NSW8770831"  = "NSW770831",
"Mq_HWC_566"  = "Cattai_566",
"Mq_Cattai_780" = "Mq_HWC_780",
"Mq_MLNP_106" = "HWC_106",
"Mq_MLNP_618" = "Cattai_618",
"NSW1214046"  = "NSW1213746"
)
for (i in seq_along(replacements)) {
prediction_gt$NSWID <- gsub(names(replacements)[i], replacements[i], prediction_gt$NSWID)
}
prediction_gt_planted <- left_join(sample_meta_planting, prediction_gt) %>%
filter (!is.na(Prediction)) #Removing those not genotyped or poorly predicted
prediction_gt_planted$UID_numb <- sub(".*_(\\d+)$", "\\1", prediction_gt_planted$NSWID)
prediction_gt_planted$UID <- ifelse(!grepl("Mq", prediction_gt_planted$ID), paste0("Mq_", prediction_gt_planted$ID), prediction_gt_planted$ID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results_UID, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
bin_monit_survey_results_mat_GT <- left_join(bin_monit_survey_results_mat, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
View(reg_monit_survey_results_mat_GT)
View(reg_monit_survey_results_UID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
View(reg_monit_survey_results_mat_GT)
prediction_gt <- read.csv("~/Uni/Doctorate/Samples/Genotyping/Report-DMela25-10753/Report-DMela25-10753/GP_Out/prediction_gt.csv") %>% dplyr::select(c(Taxa, PEV, Prediction))
colnames(prediction_gt)[1] <- "NSWID"
sample_meta_planting <- read_xlsx("C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Samples/All_samples.xlsx") %>% filter(!is.na(NSWID) & `Genotyping Purpose`=="Planting_experiment") %>% dplyr::select(NSWID, ID)
## Fixing name errors
replacements <- c(
"NSW8770831"  = "NSW770831",
"Mq_HWC_566"  = "Cattai_566",
"Mq_Cattai_780" = "Mq_HWC_780",
"Mq_MLNP_106" = "HWC_106",
"Mq_MLNP_618" = "Cattai_618",
"NSW1214046"  = "NSW1213746"
)
for (i in seq_along(replacements)) {
prediction_gt$NSWID <- gsub(names(replacements)[i], replacements[i], prediction_gt$NSWID)
}
prediction_gt_planted <- left_join(sample_meta_planting, prediction_gt) %>%
filter (!is.na(Prediction)) #Removing those not genotyped or poorly predicted
prediction_gt_planted$UID_numb <- sub(".*_(\\d+)$", "\\1", prediction_gt_planted$NSWID)
prediction_gt_planted$UID <- ifelse(!grepl("Mq", prediction_gt_planted$ID), paste0("Mq_", prediction_gt_planted$ID), prediction_gt_planted$ID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
bin_monit_survey_results_mat_GT <- left_join(bin_monit_survey_results, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
prediction_gt
## Generate a summarative score for each individual given different lengths of monitoring
mod <- lmer(`Myrtle rust worst score` ~  factor(Date) + (1|UID), data=reg_monit_survey_results_UID)
ranef_scores <- ranef(mod)$UID; ranef_scores<- rownames_to_column(ranef_scores, var="UID"); colnames(ranef_scores)[2] <- "ranef_int" # random intercepts
individual_effects <- coef(mod)$UID; individual_effects<- rownames_to_column(individual_effects, var="UID") # population adjusted BLUPs; global mean + ranef_int.
rough_summ <- reg_monit_survey_results_mat_GT %>% group_by(UID) %>% summarise (rgh_mean=mean(`Myrtle rust worst score`, na.rm=T))
summ <- left_join(rough_summ, ranef_scores); summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects, by="UID")
# Check
reg_prediction_gt_plantingexp_summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects)
## Compare prediction against blup
# Site split
reg_prediction_gt_plantingexp_comp <- ggplot(reg_prediction_gt_plantingexp_summ, aes(x=Prediction, y=`(Intercept)`)) +
geom_point(alpha=0.1) +
geom_smooth(method = 'lm', colour="grey", linetype="dashed", se=F) +
theme_bw() +
labs (title = "Prediction vs BLUP") +
facet_wrap(~Site)
ggsave(reg_prediction_gt_plantingexp_comp, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/reg_prediction_gt_plantingexp_comp.jpg", width=3500, height=2000, units="px", limitsize=F)
## Difference from worst score rescaled to 0,3 vs predicted
reg_prediction_gt_plantingexp_summ$mrws_rescale <- scales::rescale(reg_prediction_gt_plantingexp_summ$`Myrtle rust worst score`, from = c(0,5), to=c(0,3))
reg_prediction_gt_plantingexp_summ$mrws_rescale_pred_diff <- reg_prediction_gt_plantingexp_summ$mrws_rescale - reg_prediction_gt_plantingexp_summ$Prediction
## Difference over time remade\
# Colour individuals with biggest departure
UID_means <- reg_prediction_gt_plantingexp_summ %>%
group_by(UID) %>%
summarise(mean_diff = mean(mrws_rescale_pred_diff, na.rm = TRUE))
prediction_survey_res_alt <- left_join(reg_prediction_gt_plantingexp_summ, UID_means, by = "UID")
colour_thresh=3
prediction_survey_res_alt$UID_highlight <- ifelse(abs(prediction_survey_res_alt$mean_diff) > colour_thresh, prediction_survey_res_alt$UID, "Other")
colours <- length(unique(prediction_survey_res_alt$UID_highlight)) - 1
## Need to look at 1) Most recent MR incidence, 2) Last and last 2 months of MR incidence
### Load in blups
height_byMR <- reg_prediction_gt_plantingexp_summ %>%
group_by(Site, UID_numb, `(Intercept)`) %>%
mutate(n = n()) %>%
filter(n > 2) %>%
group_by(Site, UID_numb) %>%
arrange(Date, .by_group = TRUE) %>%
summarise(Height_diff = (`Height (m)` - lag(`Height (m)`)),
Season = Season,
BLUP = (`(Intercept)`),
MR_impact_overall = mean(`Myrtle rust impact score`),
MR_date = lag(`Myrtle rust worst score`, n=0),
MR_last_date = lag(`Myrtle rust worst score`, n=1),
MR_last_2date = lag(`Myrtle rust worst score`, n=2),
MR_last_3date = lag(`Myrtle rust worst score`, n=3)) %>%
ungroup()
Height_x_MR_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_date, Height_diff, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_date, Height_diff, fill=BLUP, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_2date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_2date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_2date, Height_diff, fill=BLUP, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_3date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_3date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_3date, Height_diff, fill=BLUP, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_mean_imp <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_impact_overall, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_impact_overall, Height_diff, group=BLUP, fill=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
plot_all_height_MRrecent <- Height_x_MR_date / Height_x_MR_last_date / Height_x_MR_last_2date / Height_x_MR_last_3date / Height_x_MR_mean_imp + theme(legend.position='none')
ggsave(plot_all_height_MRrecent, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_all_height_MRrecent.jpg", width=2000, height=4500, units="px", limitsize=F)
### Load in blups
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_3date + BLUP + (1|UID_numb))))
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_3date + BLUP + Summer + (1|UID_numb))))
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_3date + BLUP + Season + (1|UID_numb))))
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_date + BLUP + (1|Season) + (1|UID_numb))))
Height_x_MR_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_2date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_2date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_2date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_3date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_3date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_3date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_mean_imp <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_impact_overall, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_impact_overall, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
plot_all_height_MRrecent <- Height_x_MR_date / Height_x_MR_last_date / Height_x_MR_last_2date / Height_x_MR_last_3date / Height_x_MR_mean_imp + theme(legend.position='none')
ggsave(plot_all_height_MRrecent, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_all_height_MRrecent.jpg", width=2000, height=4500, units="px", limitsize=F)
setwd("~/Uni/Doctorate/Samples/Seedlot_plot_data/")
LoadedinData <- read.csv("data/final_seedloty_plot.csv")
shiny::runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
library(tidyr) # data wrangling
library(raster) # Map
library(sf) # Map
library(shiny) # shiny base package
library(shinycssloaders) # load symbol
library(leaflet) # Map
library(shinyBS) # layout
setwd("~/Uni/Doctorate/Samples/Seedlot_plot_data/")
# Load in datasets used
LoadedinData <- read.csv("data/final_seedloty_plot.csv")
# Load current projection data
maxent_MQuin <- raster("data/maxent_MQuin.tiff")
maxent_MR <- raster("data/maxent_MR.tiff")
maxent_intersection <- raster("data/maxent_intersection.tiff")
maxent_studyarea <- st_read("data/maxent_studyarea.gpkg")
# Palettes
# For seedlots based on severity - actively shifts based on observed data
MR_Sev_pal <- colorNumeric(
palette = "YlOrRd",  # Yellow → Orange → Red
domain = LoadedinData$Mean_seedling_score_rustassay,
na.color = "gray50"
)
# For SDMs
pal_mr <- colorRampPalette(c("grey95","#C6DC96","#C6DC96","darkolivegreen","yellow"))
pal_mq <- colorRampPalette(c("grey95","#EAC8BF","#EAC8BF","orange","forestgreen"))
pal_int <- colorRampPalette(c("grey95","#C6DC96","#C6DC96","#45B055","#4870BD", "deeppink4"))
function(input, output, session) {
# Render initial map
output$map <- renderLeaflet({
leaflet() %>%
setView(lng=151.20990, lat=-33.865143, zoom=8) %>%
addProviderTiles(providers$CartoDB.Positron)
})
# Filter seedlots based on input filters
filtered_data <- reactive({
data <- LoadedinData
# Apply rust filter only if checkbox is TRUE
if (input$filter_rust) {
data <- data %>%
filter(Mean_seedling_score_rustassay >= as.numeric(input$rustFilter[1]),
Mean_seedling_score_rustassay <= as.numeric(input$rustFilter[2]))
}
if (input$filter_geno) {
data <- data %>%
filter(Mean_seedling_score_genompred >= as.numeric(input$genoFilter[1]),
Mean_seedling_score_genompred <= as.numeric(input$genoFilter[2]))
}
if (input$filter_geno_pres) {
data <- data %>%
filter(!is.na(Mean_seedling_score_genompred))
}
if (input$filter_assay_pres) {
data <- data %>%
filter(!is.na(Mean_seedling_score_rustassay))
}
if (input$filter_seedling_numb) {
data <- data %>%
filter(Seedling_number_rustassay >= as.numeric(input$seedlNumbFilter[1]) &
Seedling_number_rustassay <= as.numeric(input$seedlNumbFilter[2]) |
Seedling_number_genompred >= as.numeric(input$seedlNumbFilter[1]) &
Seedling_number_genompred <= as.numeric(input$seedlNumbFilter[2]) )
}
data
})
observe({
data <- filtered_data()
# Create popup labels for seedlots
popup_info <- paste0(
"<b>Seedlot: </b>", data$Seedlot, "<br>",
"<p>",
"Seedlings Scored (Rust Assay): ", round(data$Seedling_number_rustassay, 2), "<br>",
"Mean Score (Rust Assay): ", round(data$Mean_seedling_score_rustassay, 2), "<br>",
"SD Score (Rust Assay): ", round(data$Sd_seedling_score_rustassay, 2), "<br>",
"</p>",
"<p>",
"Seedlings Scored (Genomic Prediction): ", round(data$Seedling_number_genompred, 2), "<br>",
"Mean Score (Genomic Prediction): ", round(data$Mean_seedling_score_genompred, 2), "<br>",
"SD Score (Genomic Prediction): ", round(data$Sd_seedling_score_genompred, 2), "<br>",
"</p>",
"<p>",
"Latitude collected: ", data$latitude, "<br>",
"Longitude collected: ", data$longitude,
"</p>"
)
### Loading in Map
leafletProxy("map") %>%
## Clean map to update reactively to changes
clearMarkers() %>%
clearMarkerClusters() %>%
clearControls() %>%
## Seedlots
addCircleMarkers(
lng = data$longitude,
lat = data$latitude,
popup = popup_info,
stroke = FALSE,
radius = 6,
fillOpacity = 0.8,
fillColor = MR_Sev_pal(data$Mean_seedling_score_rustassay),
## Colouring in seedlots based on severity
options = markerOptions(
rust = data$Mean_seedling_score_rustassay  # pass custom variable here
),
## JS for colouring based on rust in child clusters
clusterOptions = markerClusterOptions(
spiderfyDistanceMultiplier=1.5,
# Colour clusters
iconCreateFunction = JS("
function(cluster) {
var markers = cluster.getAllChildMarkers();
var sum = 0;
var count = 0;
for (var i = 0; i < markers.length; i++) {
var rust = markers[i].options.rust;
if (rust != null) {
sum += rust;
count += 1;
}
}
var avg = count > 0 ? sum / count : 0;
var color = '';
if (avg < 10) { color = '#ffffb2'; }
else if (avg < 30) { color = '#fecc5c'; }
else if (avg < 50) { color = '#fd8d3c'; }
else { color = '#e31a1c'; }
return L.divIcon({
html: '<div style=\"background-color:' + color + '\"><span>' + cluster.getChildCount() + '</span></div>',
className: 'marker-cluster',
iconSize: L.point(40, 40)
});
}
"),
colors = MR_Sev_pal
)
)
## Loading in rasters for SDM
if (input$overlay_SDM) {
selected_raster <- switch(input$layer_curr,
"MQuin" = maxent_MQuin,
"MR" = maxent_MR,
"Intersection" = maxent_intersection)
selected_palette <- switch(input$layer_curr,
"MQuin" = pal_mq(20),
"MR" = pal_mr(20),
"Intersection" = pal_int(20))
color_pal <- colorNumeric(palette = selected_palette, domain = values(selected_raster), na.color = "transparent")
leafletProxy("map") %>%
addRasterImage(selected_raster, colors = selected_palette, opacity = 0.8, group = input$layer_curr) %>%
addLegend(position = "topright", pal = color_pal, values = values(selected_raster), title = "SDM value", group = input$layer_curr)
}
# Add legend on map
if (nrow(data) > 1 && !all(is.na(data$Mean_seedling_score_rustassay))) {
leafletProxy("map") %>%
addLegend(
position = "bottomright",
pal = MR_Sev_pal,
values = data$Mean_seedling_score_rustassay,
title = "Seedlot's mean rust assay score",
opacity = 1
)
}
## Loading in the user input location
observeEvent(input$go, {
req(input$latitude); req(input$longitude)
inp_latitude <- as.numeric(input$latitude)
inp_longitude <- as.numeric(input$longitude)
# Zoom map to location
leafletProxy("map") %>%
flyToBounds(lng1 = inp_longitude-0.15, lng2 = inp_longitude+0.15, lat1 = inp_latitude-0.15, lat2 = inp_latitude+0.15, options = c(duration=0.3))
})
})
}
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
runApp('Seedlot_plot_ShinyMap')
