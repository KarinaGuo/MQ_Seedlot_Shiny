bin_monit_survey_results <- bin_monit_survey_results_mat
reg_monit_survey_results$Date <- as.Date(reg_monit_survey_results$Date); reg_monit_survey_results$Month <- format(reg_monit_survey_results$Date, "%m"); reg_monit_survey_results$Year <- format(reg_monit_survey_results$Date, "%y"); reg_monit_survey_results$UID_numb <- as.character(reg_monit_survey_results$UID_numb); reg_monit_survey_results <- reg_monit_survey_results %>% filter(!is.na(UID_numb))
bin_monit_survey_results$Date <- as.Date(bin_monit_survey_results$Date); bin_monit_survey_results$Month <- format(bin_monit_survey_results$Date, "%m"); bin_monit_survey_results$Year <- format(bin_monit_survey_results$Date, "%y"); bin_monit_survey_results$UID_numb <- as.character(bin_monit_survey_results$UID_numb); bin_monit_survey_results <- bin_monit_survey_results %>% filter(!is.na(UID_numb))
survey_results_dead_indv$Date <- as.Date(survey_results_dead_indv$Date); survey_results_dead_indv$Month <- format(survey_results_dead_indv$Date, "%m"); survey_results_dead_indv$Year <- format(survey_results_dead_indv$Date, "%y"); survey_results_dead_indv$UID_numb <- as.character(survey_results_dead_indv$UID_numb); survey_results_dead_indv <- survey_results_dead_indv %>% filter(!is.na(UID_numb))
planting_dates$Date <- as.Date(planting_dates$Date); planting_dates$Month <- format(planting_dates$Date, "%m"); planting_dates$Year <- format(planting_dates$Date, "%y")
library(lubridate)
season_rects <- reg_monit_survey_results %>%
mutate(
Year = year(Date),
Month = month(Date),
Season = case_when(
Month %in% c(12, 1, 2) ~ "Summer",
Month %in% c(3, 4, 5) ~ "Autumn",
Month %in% c(6, 7, 8) ~ "Winter",
Month %in% c(9, 10, 11) ~ "Spring"
),
Season_Year = if_else(Month == 12, Year + 1, Year)
) %>%
mutate(
season_start = case_when(
Season == "Summer" ~ as.Date(paste0(Season_Year - 1, "-12-01")),
Season == "Autumn" ~ as.Date(paste0(Season_Year, "-03-01")),
Season == "Winter" ~ as.Date(paste0(Season_Year, "-06-01")),
Season == "Spring" ~ as.Date(paste0(Season_Year, "-09-01"))
),
season_end = case_when(
Season == "Summer" ~ as.Date(paste0(Season_Year, "-02-", days_in_month(2))),
Season == "Autumn" ~ as.Date(paste0(Season_Year, "-05-", days_in_month(5))),
Season == "Winter" ~ as.Date(paste0(Season_Year, "-08-", days_in_month(8))),
Season == "Spring" ~ as.Date(paste0(Season_Year, "-11-", days_in_month(11)))
)
) %>%
dplyr::select(Year, Month, Season, season_start, season_end)
season_rects <- unique(season_rects %>% dplyr::select(season_start, season_end, Season))
reg_monit_survey_results$Season <- case_when(
as.numeric(reg_monit_survey_results$Month) %in% c(12, 1, 2) ~ "Summer",
as.numeric(reg_monit_survey_results$Month) %in% c(3, 4, 5) ~ "Autumn",
as.numeric(reg_monit_survey_results$Month) %in% c(6, 7, 8) ~ "Winter",
as.numeric(reg_monit_survey_results$Month) %in% c(9, 10, 11) ~ "Spring"
)
bin_monit_survey_results$Season <- case_when(
as.numeric(bin_monit_survey_results$Month) %in% c(12, 1, 2) ~ "Summer",
as.numeric(bin_monit_survey_results$Month) %in% c(3, 4, 5) ~ "Autumn",
as.numeric(bin_monit_survey_results$Month) %in% c(6, 7, 8) ~ "Winter",
as.numeric(bin_monit_survey_results$Month) %in% c(9, 10, 11) ~ "Spring"
)
### UID averages
UID_scores_overall <- reg_monit_survey_results %>%
group_by(UID_numb, Site) %>%
summarise(mean_impact = mean(`Myrtle rust impact score`, na.rm = TRUE)) %>%
mutate(mean_UID_impact = case_when(
mean_impact == 0 ~ "No infection",
mean_impact > 0 & mean_impact <= 1 ~ "Low",
mean_impact >= 1 & mean_impact <= 3 ~ "Mid",
mean_impact >= 4 & mean_impact <= 5 ~ "High",
TRUE ~ NA_character_)) %>%
mutate(mean_UID_impact = factor(mean_UID_impact, levels = c("No infection","Low", "Mid", "High"))) %>%
ungroup()
survey_results_rm_snapped <- reg_monit_survey_results %>% filter(!(UID_numb %in% survey_results_snapped_indv$UID_numb))
survey_results_rm_snapped_meanUID <- left_join(survey_results_rm_snapped, UID_scores_overall)
## Most recent
recent_survey <- max(reg_monit_survey_results$Month)
survey_results_recents <- reg_monit_survey_results %>%
filter(Month==recent_survey)
# Chunk 1: libraries
library(readxl)
library(tidyverse)
library(patchwork)
library(lubridate)
library(geodata)
library(raster)
library(lme4)
# Chunk 2: data setup
planting_dates <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "Planting date"))
# LMCC
reg_monit_survey_results_LMC <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "LMC-Cold Tea Creek"))
survey_results_snapped_indv_LMC <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "LMC-Cold Tea Creek-Snapped"))
survey_results_dead_indv_LMC <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "LMC-Cold Tea Creek - Dead"))
# Cattai
reg_monit_survey_results_Cattai <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "Cattai_RegMonit"))
bin_monit_survey_results_Cattai <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "Cattai_Binary"))
survey_results_dead_indv_Cattai <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "Cattai_plant-dead"))
survey_results_snapped_indv_Cattai <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "LMC-Cold Tea Creek-Snapped"))
# HWC
reg_monit_survey_results_HWC <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "HWC_RegMonit"))
bin_monit_survey_results_HWC <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "HWC_Binary"))
survey_results_dead_indv_HWC <- as.data.frame(read_xlsx(path="C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Ch Planting/Measurements/Tag_track.xlsx", sheet = "HWC_plant-dead"))
## Join all together
reg_monit_survey_results <- rbind(reg_monit_survey_results_LMC, reg_monit_survey_results_Cattai, reg_monit_survey_results_HWC); reg_monit_survey_results$UID_numb <- as.character(reg_monit_survey_results$UID_numb)
bin_monit_survey_results <- rbind(bin_monit_survey_results_Cattai, bin_monit_survey_results_HWC); bin_monit_survey_results$UID_numb <- as.character(bin_monit_survey_results$UID_numb)
survey_results_dead_indv <- rbind(survey_results_dead_indv_LMC, survey_results_dead_indv_Cattai, survey_results_dead_indv_HWC); survey_results_dead_indv$UID_numb <- as.character(survey_results_dead_indv$UID_numb)
survey_results_snapped_indv <- rbind(survey_results_snapped_indv_LMC); survey_results_snapped_indv$UID_numb <- as.character(survey_results_snapped_indv$UID_numb)
# UID and site planted
combined <- rbind(
reg_monit_survey_results[, c("UID_numb", "Site")],
bin_monit_survey_results[, c("UID_numb", "Site")]
)
planted_indivs_meta <- read_xlsx("~/Uni/Doctorate/Ch Planting/data/IIDs.xlsx", sheet="Mquin_Planting_Experiment_TagTe"); colnames(planted_indivs_meta) <- c("Maternal_line", "UID", "Mat_line_Sitecoll")
planted_indivs_meta$UID_numb <- sub(".*_.*_(\\d+)$", "\\1", planted_indivs_meta$UID)
## Maternal line
prediction_gt_plantingexp <- read_xlsx("~/Uni/Doctorate/Ch Planting/data/IIDs.xlsx", sheet="MatLine_Info"); colnames(prediction_gt_plantingexp)[1:2] <- c("Maternal_line", "Mat_line_Sitecoll")
prediction_gt_plantingexp$Maternal_line <- as.numeric(gsub("NSW", "", prediction_gt_plantingexp$Maternal_line))
prediction_gt_plantingexp_mat <- left_join(prediction_gt_plantingexp, planted_indivs_meta)
## Adding in maternal values
### Remove LMC (not Cat 2)
reg_monit_survey_results_rmLMC <- reg_monit_survey_results %>% filter (!(Site == "Cold Tea Creek_LMC"))
reg_monit_survey_results_LMC <- reg_monit_survey_results %>% filter ((Site == "Cold Tea Creek_LMC"))
reg_monit_survey_results_mat <- left_join(reg_monit_survey_results_rmLMC[,!(names(reg_monit_survey_results) %in% "UID")], prediction_gt_plantingexp_mat, by="UID_numb")
bin_monit_survey_results_mat <- left_join(bin_monit_survey_results[,!(names(bin_monit_survey_results) %in% "UID")], prediction_gt_plantingexp_mat, by="UID_numb")
survey_results_dead_indv_mat <- left_join(survey_results_dead_indv, prediction_gt_plantingexp_mat, by="UID_numb")
survey_results_snapped_indv_mat <- left_join(survey_results_snapped_indv, prediction_gt_plantingexp_mat, by="UID_numb")
## Propagating UID with matching UID_numb
reg_monit_survey_results <- rbind(reg_monit_survey_results_LMC, reg_monit_survey_results_mat %>% dplyr::select(colnames(reg_monit_survey_results_LMC)))
bin_monit_survey_results <- bin_monit_survey_results_mat
# Chunk 3
reg_monit_survey_results$Date <- as.Date(reg_monit_survey_results$Date); reg_monit_survey_results$Month <- format(reg_monit_survey_results$Date, "%m"); reg_monit_survey_results$Year <- format(reg_monit_survey_results$Date, "%y"); reg_monit_survey_results$UID_numb <- as.character(reg_monit_survey_results$UID_numb); reg_monit_survey_results <- reg_monit_survey_results %>% filter(!is.na(UID_numb))
bin_monit_survey_results$Date <- as.Date(bin_monit_survey_results$Date); bin_monit_survey_results$Month <- format(bin_monit_survey_results$Date, "%m"); bin_monit_survey_results$Year <- format(bin_monit_survey_results$Date, "%y"); bin_monit_survey_results$UID_numb <- as.character(bin_monit_survey_results$UID_numb); bin_monit_survey_results <- bin_monit_survey_results %>% filter(!is.na(UID_numb))
survey_results_dead_indv$Date <- as.Date(survey_results_dead_indv$Date); survey_results_dead_indv$Month <- format(survey_results_dead_indv$Date, "%m"); survey_results_dead_indv$Year <- format(survey_results_dead_indv$Date, "%y"); survey_results_dead_indv$UID_numb <- as.character(survey_results_dead_indv$UID_numb); survey_results_dead_indv <- survey_results_dead_indv %>% filter(!is.na(UID_numb))
planting_dates$Date <- as.Date(planting_dates$Date); planting_dates$Month <- format(planting_dates$Date, "%m"); planting_dates$Year <- format(planting_dates$Date, "%y")
library(lubridate)
season_rects <- reg_monit_survey_results %>%
mutate(
Year = year(Date),
Month = month(Date),
Season = case_when(
Month %in% c(12, 1, 2) ~ "Summer",
Month %in% c(3, 4, 5) ~ "Autumn",
Month %in% c(6, 7, 8) ~ "Winter",
Month %in% c(9, 10, 11) ~ "Spring"
),
Season_Year = if_else(Month == 12, Year + 1, Year)
) %>%
mutate(
season_start = case_when(
Season == "Summer" ~ as.Date(paste0(Season_Year - 1, "-12-01")),
Season == "Autumn" ~ as.Date(paste0(Season_Year, "-03-01")),
Season == "Winter" ~ as.Date(paste0(Season_Year, "-06-01")),
Season == "Spring" ~ as.Date(paste0(Season_Year, "-09-01"))
),
season_end = case_when(
Season == "Summer" ~ as.Date(paste0(Season_Year, "-02-", days_in_month(2))),
Season == "Autumn" ~ as.Date(paste0(Season_Year, "-05-", days_in_month(5))),
Season == "Winter" ~ as.Date(paste0(Season_Year, "-08-", days_in_month(8))),
Season == "Spring" ~ as.Date(paste0(Season_Year, "-11-", days_in_month(11)))
)
) %>%
dplyr::select(Year, Month, Season, season_start, season_end)
season_rects <- unique(season_rects %>% dplyr::select(season_start, season_end, Season))
reg_monit_survey_results$Season <- case_when(
as.numeric(reg_monit_survey_results$Month) %in% c(12, 1, 2) ~ "Summer",
as.numeric(reg_monit_survey_results$Month) %in% c(3, 4, 5) ~ "Autumn",
as.numeric(reg_monit_survey_results$Month) %in% c(6, 7, 8) ~ "Winter",
as.numeric(reg_monit_survey_results$Month) %in% c(9, 10, 11) ~ "Spring"
)
bin_monit_survey_results$Season <- case_when(
as.numeric(bin_monit_survey_results$Month) %in% c(12, 1, 2) ~ "Summer",
as.numeric(bin_monit_survey_results$Month) %in% c(3, 4, 5) ~ "Autumn",
as.numeric(bin_monit_survey_results$Month) %in% c(6, 7, 8) ~ "Winter",
as.numeric(bin_monit_survey_results$Month) %in% c(9, 10, 11) ~ "Spring"
)
### UID averages
UID_scores_overall <- reg_monit_survey_results %>%
group_by(UID_numb, Site) %>%
summarise(mean_impact = mean(`Myrtle rust impact score`, na.rm = TRUE)) %>%
mutate(mean_UID_impact = case_when(
mean_impact == 0 ~ "No infection",
mean_impact > 0 & mean_impact <= 1 ~ "Low",
mean_impact >= 1 & mean_impact <= 3 ~ "Mid",
mean_impact >= 4 & mean_impact <= 5 ~ "High",
TRUE ~ NA_character_)) %>%
mutate(mean_UID_impact = factor(mean_UID_impact, levels = c("No infection","Low", "Mid", "High"))) %>%
ungroup()
survey_results_rm_snapped <- reg_monit_survey_results %>% filter(!(UID_numb %in% survey_results_snapped_indv$UID_numb))
survey_results_rm_snapped_meanUID <- left_join(survey_results_rm_snapped, UID_scores_overall)
## Most recent
recent_survey <- max(reg_monit_survey_results$Month)
survey_results_recents <- reg_monit_survey_results %>%
filter(Month==recent_survey)
# Chunk 4
prediction_gt <- read.csv("~/Uni/Doctorate/Samples/Genotyping/Report-DMela25-10753/Report-DMela25-10753/GP_Out/prediction_gt.csv") %>% dplyr::select(c(Taxa, PEV, Prediction))
colnames(prediction_gt)[1] <- "NSWID"
sample_meta_planting <- read_xlsx("C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Samples/All_samples.xlsx") %>% filter(!is.na(NSWID) & `Genotyping Purpose`=="Planting_experiment") %>% dplyr::select(NSWID, ID)
## Fixing name errors
replacements <- c(
"NSW8770831"  = "NSW770831",
"Mq_HWC_566"  = "Cattai_566",
"Mq_Cattai_780" = "Mq_HWC_780",
"Mq_MLNP_106" = "HWC_106",
"Mq_MLNP_618" = "Cattai_618",
"NSW1214046"  = "NSW1213746"
)
for (i in seq_along(replacements)) {
prediction_gt$NSWID <- gsub(names(replacements)[i], replacements[i], prediction_gt$NSWID)
}
prediction_gt_planted <- left_join(sample_meta_planting, prediction_gt) %>%
filter (!is.na(Prediction)) #Removing those not genotyped or poorly predicted
prediction_gt_planted$UID_numb <- sub(".*_(\\d+)$", "\\1", prediction_gt_planted$NSWID)
prediction_gt_planted$UID <- ifelse(!grepl("Mq", prediction_gt_planted$ID), paste0("Mq_", prediction_gt_planted$ID), prediction_gt_planted$ID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results_UID, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
bin_monit_survey_results_mat_GT <- left_join(bin_monit_survey_results_mat, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
# Chunk 5
survey_results_summed_date_worst <- reg_monit_survey_results %>% group_by(`Myrtle rust worst score`, Site, Date) %>% filter(!is.na(`Myrtle rust worst score`)) %>% summarise (n=n()) %>% complete(Date = max(Date), fill = list(n = 0))
survey_results_summed_date_impact <- reg_monit_survey_results %>% group_by(`Myrtle rust impact score`, Site, Date) %>% filter(!is.na(`Myrtle rust impact score`)) %>% summarise (n=n()) %>% complete(Date = max(Date), fill = list(n = 0))
########## Todo: For the group with Site and max(Date), add a Myrtle rust impact score of 0 if that group does not exist
score_levels <- sort(unique(survey_results_recents$`Myrtle rust worst score`))
colors <- colorRampPalette(c( "forestgreen", "red"))(length(score_levels))
plot_dates_worst <- ggplot(survey_results_summed_date_worst, aes(x=Date, y=n, group=as.factor(`Myrtle rust worst score`), fill=as.factor(`Myrtle rust worst score`),colour=as.factor(`Myrtle rust worst score`))) +
geom_line(linewidth=0.1) +
geom_point(alpha=0.5, size=0.5) +
geom_ribbon(data=survey_results_summed_date_worst, aes(ymin = 0, ymax = n), alpha = 0.2, colour = NA) +
theme_bw() +
geom_vline(data=planting_dates, aes(xintercept=Date), colour='grey70', linetype="dashed", linewidth=0.5) +
scale_fill_manual(values = setNames(colors, score_levels)) +
scale_colour_manual(values = setNames(colors, score_levels)) +
labs(fill="Myrtle rust score", x="Date", y="Total sample count", title="Count of MR worst score across time") +
ggnewscale::new_scale_fill() +
geom_rect(data = season_rects, aes(xmin = as.numeric(season_start), xmax = as.numeric(season_end),  ymin = -Inf, ymax = Inf,  fill = Season), alpha = 0.1, inherit.aes = FALSE) +
scale_fill_manual(values = c("Autumn" = "goldenrod1", "Winter" = "skyblue", "Spring"="palegreen2", Summer="rosybrown1")) +
facet_wrap(~Site) +
guides(colour="none")
plot_dates_impact <- ggplot(survey_results_summed_date_impact, aes(x=Date, y=n, group=as.factor(`Myrtle rust impact score`), fill=as.factor(`Myrtle rust impact score`),colour=as.factor(`Myrtle rust impact score`))) +
geom_point(alpha=0.5, size=0.5) +
geom_line(linewidth=0.1) +
geom_ribbon(data=survey_results_summed_date_impact, aes(ymin = 0, ymax = n), alpha = 0.2, colour = NA) +
theme_bw() +
geom_vline(data=planting_dates, aes(xintercept=Date), colour='grey70', linetype="dashed", linewidth=0.5) +
scale_fill_manual(values = setNames(colors, score_levels)) +
scale_colour_manual(values = setNames(colors, score_levels)) +
ggnewscale::new_scale_fill() +
geom_rect(data = season_rects, aes(xmin = as.numeric(season_start), xmax = as.numeric(season_end),  ymin = -Inf, ymax = Inf,  fill = Season), alpha = 0.1, inherit.aes = FALSE) +
scale_fill_manual(values = c("Autumn" = "goldenrod1", "Winter" = "skyblue", "Spring"="palegreen2", Summer="rosybrown1")) +
facet_wrap(~Site) +
theme(legend.position = "none") +
labs(fill="Myrtle rust score", x="Date", y="Total sample count", title="Count of MR impact score across time")
plot_both <- plot_dates_worst/plot_dates_impact + plot_layout(guides = "collect", axes = "collect")
ggsave(plot_both, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_dates_imp_worst.jpg", width=4000, height=2500, units="px", limitsize=F)
# Chunk 6
score_levels <- sort(unique(survey_results_rm_snapped_meanUID$mean_UID_impact))
colors <- colorRampPalette(c( "forestgreen", "red"))(length(score_levels))
plot_dates_height <- ggplot() +
geom_rect(data = season_rects, aes(xmin = as.numeric(season_start), xmax = as.numeric(season_end),  ymin = -Inf, ymax = Inf,  fill = Season), alpha = 0.1, inherit.aes = FALSE) +
scale_fill_manual(values = c("Autumn" = "goldenrod1", "Winter" = "skyblue", "Spring"="palegreen2", Summer="rosybrown1")) +
ggnewscale::new_scale_fill() +
geom_point(data=survey_results_rm_snapped_meanUID, aes(x=Date, y=`Height (m)`, group=as.factor(mean_UID_impact), colour=mean_UID_impact, fill=mean_UID_impact), alpha=0.2) +
geom_line(data=survey_results_rm_snapped_meanUID, aes(x=Date, y=`Height (m)`, group=UID_numb, colour=mean_UID_impact), stat="smooth", method='lm', linewidth=0.5, se=F, alpha=0.1) +
stat_smooth(data=survey_results_rm_snapped_meanUID, aes(x=Date, y=`Height (m)`, group=as.factor(mean_UID_impact), colour=mean_UID_impact, fill=mean_UID_impact), method='lm', linewidth=0.5, se=T, alpha=0.1) +
theme_bw() +
scale_colour_manual(values = setNames(colors, score_levels)) +
scale_fill_manual(values = setNames(colors, score_levels)) +
labs(colour="Mean individual impact category", x="Date") +
guides(fill='none') +
geom_vline(data=planting_dates, aes(xintercept=Date), colour='grey70', linetype="dashed", linewidth=0.5) +
facet_wrap(~Site)
plot_dates_height
ggsave(plot_dates_height, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_dates_height.jpg", width=3000, height=2000, units="px", limitsize=F)
# Chunk 7
# Final height (most recent) comparisons
final_date=max(survey_results_rm_snapped_meanUID$Month)
Final_height <- survey_results_rm_snapped_meanUID %>%
filter(Month == final_date) %>%
mutate(mean_UID_impact = factor(mean_UID_impact, levels = c("No infection","Low", "Mid", "High")))
score_levels <- sort(unique(Final_height$mean_UID_impact))
colors <- colorRampPalette(c( "forestgreen", "red"))(length(score_levels))
summary(aov(formula = `Height (m)` ~ mean_UID_impact, data=Final_height))
summary(lm(formula = `Height (m)` ~ mean_impact, data=Final_height))
final_height_cat <- ggplot(Final_height, aes(x=mean_UID_impact, y=as.numeric(`Height (m)`), group=as.factor(mean_UID_impact), fill=as.factor(mean_UID_impact))) +
geom_boxplot(alpha=0.4) +
geom_jitter(width=0.2, alpha=0.2) +
theme_bw() +
scale_fill_manual(values = setNames(colors, score_levels))+
labs(y="Height (m)", x="Mean MR impact score") +
facet_wrap(~Site)
final_height_cat
ggsave(final_height_cat, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/final_height_cat.jpg", width=3000, height=2000, units="px", limitsize=F)
final_height_quant <- ggplot(Final_height, aes(x=mean_impact, y=as.numeric(`Height (m)`))) +
geom_point(alpha=0.4) +
theme_bw() +
stat_smooth(method="lm", se=F) +
labs(y="Height (m)", x="Mean MR impact score") +
facet_wrap(~Site)
final_height_quant
## Need to look at 1) Most recent MR incidence, 2) Last and last 2 months of MR incidence
### Load in blups
height_byMR <- reg_prediction_gt_plantingexp_summ %>%
group_by(Site, UID_numb, `(Intercept)`) %>%
mutate(n = n()) %>%
filter(n > 2) %>%
group_by(Site, UID_numb) %>%
arrange(Date, .by_group = TRUE) %>%
summarise(Height_diff = (`Height (m)` - lag(`Height (m)`)),
Season = Season,
BLUP = (`(Intercept)`),
MR_impact_overall = mean(`Myrtle rust impact score`),
MR_date = lag(`Myrtle rust worst score`, n=0),
MR_last_date = lag(`Myrtle rust worst score`, n=1),
MR_last_2date = lag(`Myrtle rust worst score`, n=2),
MR_last_3date = lag(`Myrtle rust worst score`, n=3)) %>%
ungroup()
View(reg_prediction_gt_plantingexp_summ)
prediction_gt
## Generate a summarative score for each individual given different lengths of monitoring
mod <- lmer(`Myrtle rust worst score` ~  factor(Date) + (1|UID), data=reg_monit_survey_results_UID)
ranef_scores <- ranef(mod)$UID; ranef_scores<- rownames_to_column(ranef_scores, var="UID"); colnames(ranef_scores)[2] <- "ranef_int" # random intercepts
individual_effects <- coef(mod)$UID; individual_effects<- rownames_to_column(individual_effects, var="UID") # population adjusted BLUPs; global mean + ranef_int.
rough_summ <- reg_monit_survey_results_mat_GT %>% group_by(UID) %>% summarise (rgh_mean=mean(`Myrtle rust worst score`, na.rm=T))
summ <- left_join(rough_summ, ranef_scores); summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects, by="UID")
# Check
reg_prediction_gt_plantingexp_summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects)
## Compare prediction against blup
# Site split
reg_prediction_gt_plantingexp_comp <- ggplot(reg_prediction_gt_plantingexp_summ, aes(x=Prediction, y=`(Intercept)`)) +
geom_point(alpha=0.1) +
geom_smooth(method = 'lm', colour="grey", linetype="dashed", se=F) +
theme_bw() +
labs (title = "Prediction vs BLUP") +
facet_wrap(~Site)
ggsave(reg_prediction_gt_plantingexp_comp, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/reg_prediction_gt_plantingexp_comp.jpg", width=3500, height=2000, units="px", limitsize=F)
## Difference from worst score rescaled to 0,3 vs predicted
reg_prediction_gt_plantingexp_summ$mrws_rescale <- scales::rescale(reg_prediction_gt_plantingexp_summ$`Myrtle rust worst score`, from = c(0,5), to=c(0,3))
reg_prediction_gt_plantingexp_summ$mrws_rescale_pred_diff <- reg_prediction_gt_plantingexp_summ$mrws_rescale - reg_prediction_gt_plantingexp_summ$Prediction
## Difference over time remade\
# Colour individuals with biggest departure
UID_means <- reg_prediction_gt_plantingexp_summ %>%
group_by(UID) %>%
summarise(mean_diff = mean(mrws_rescale_pred_diff, na.rm = TRUE))
prediction_survey_res_alt <- left_join(reg_prediction_gt_plantingexp_summ, UID_means, by = "UID")
colour_thresh=3
prediction_survey_res_alt$UID_highlight <- ifelse(abs(prediction_survey_res_alt$mean_diff) > colour_thresh, prediction_survey_res_alt$UID, "Other")
colours <- length(unique(prediction_survey_res_alt$UID_highlight)) - 1
## Need to look at 1) Most recent MR incidence, 2) Last and last 2 months of MR incidence
### Load in blups
height_byMR <- reg_prediction_gt_plantingexp_summ %>%
group_by(Site, UID_numb, `(Intercept)`) %>%
mutate(n = n()) %>%
filter(n > 2) %>%
group_by(Site, UID_numb) %>%
arrange(Date, .by_group = TRUE) %>%
summarise(Height_diff = (`Height (m)` - lag(`Height (m)`)),
Season = Season,
BLUP = (`(Intercept)`),
MR_impact_overall = mean(`Myrtle rust impact score`),
MR_date = lag(`Myrtle rust worst score`, n=0),
MR_last_date = lag(`Myrtle rust worst score`, n=1),
MR_last_2date = lag(`Myrtle rust worst score`, n=2),
MR_last_3date = lag(`Myrtle rust worst score`, n=3)) %>%
ungroup()
View(reg_prediction_gt_plantingexp_summ)
View(reg_monit_survey_results_mat_GT)
prediction_gt <- read.csv("~/Uni/Doctorate/Samples/Genotyping/Report-DMela25-10753/Report-DMela25-10753/GP_Out/prediction_gt.csv") %>% dplyr::select(c(Taxa, PEV, Prediction))
colnames(prediction_gt)[1] <- "NSWID"
sample_meta_planting <- read_xlsx("C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Samples/All_samples.xlsx") %>% filter(!is.na(NSWID) & `Genotyping Purpose`=="Planting_experiment") %>% dplyr::select(NSWID, ID)
## Fixing name errors
replacements <- c(
"NSW8770831"  = "NSW770831",
"Mq_HWC_566"  = "Cattai_566",
"Mq_Cattai_780" = "Mq_HWC_780",
"Mq_MLNP_106" = "HWC_106",
"Mq_MLNP_618" = "Cattai_618",
"NSW1214046"  = "NSW1213746"
)
for (i in seq_along(replacements)) {
prediction_gt$NSWID <- gsub(names(replacements)[i], replacements[i], prediction_gt$NSWID)
}
prediction_gt_planted <- left_join(sample_meta_planting, prediction_gt) %>%
filter (!is.na(Prediction)) #Removing those not genotyped or poorly predicted
prediction_gt_planted$UID_numb <- sub(".*_(\\d+)$", "\\1", prediction_gt_planted$NSWID)
prediction_gt_planted$UID <- ifelse(!grepl("Mq", prediction_gt_planted$ID), paste0("Mq_", prediction_gt_planted$ID), prediction_gt_planted$ID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results_UID, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
bin_monit_survey_results_mat_GT <- left_join(bin_monit_survey_results_mat, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
View(reg_monit_survey_results_mat_GT)
View(reg_monit_survey_results_UID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
View(reg_monit_survey_results_mat_GT)
prediction_gt <- read.csv("~/Uni/Doctorate/Samples/Genotyping/Report-DMela25-10753/Report-DMela25-10753/GP_Out/prediction_gt.csv") %>% dplyr::select(c(Taxa, PEV, Prediction))
colnames(prediction_gt)[1] <- "NSWID"
sample_meta_planting <- read_xlsx("C:/Users/swirl/OneDrive/Documents/Uni/Doctorate/Samples/All_samples.xlsx") %>% filter(!is.na(NSWID) & `Genotyping Purpose`=="Planting_experiment") %>% dplyr::select(NSWID, ID)
## Fixing name errors
replacements <- c(
"NSW8770831"  = "NSW770831",
"Mq_HWC_566"  = "Cattai_566",
"Mq_Cattai_780" = "Mq_HWC_780",
"Mq_MLNP_106" = "HWC_106",
"Mq_MLNP_618" = "Cattai_618",
"NSW1214046"  = "NSW1213746"
)
for (i in seq_along(replacements)) {
prediction_gt$NSWID <- gsub(names(replacements)[i], replacements[i], prediction_gt$NSWID)
}
prediction_gt_planted <- left_join(sample_meta_planting, prediction_gt) %>%
filter (!is.na(Prediction)) #Removing those not genotyped or poorly predicted
prediction_gt_planted$UID_numb <- sub(".*_(\\d+)$", "\\1", prediction_gt_planted$NSWID)
prediction_gt_planted$UID <- ifelse(!grepl("Mq", prediction_gt_planted$ID), paste0("Mq_", prediction_gt_planted$ID), prediction_gt_planted$ID)
reg_monit_survey_results_mat_GT <- left_join(reg_monit_survey_results, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
bin_monit_survey_results_mat_GT <- left_join(bin_monit_survey_results, prediction_gt_planted %>% dplyr::select(UID, PEV, Prediction))
prediction_gt
## Generate a summarative score for each individual given different lengths of monitoring
mod <- lmer(`Myrtle rust worst score` ~  factor(Date) + (1|UID), data=reg_monit_survey_results_UID)
ranef_scores <- ranef(mod)$UID; ranef_scores<- rownames_to_column(ranef_scores, var="UID"); colnames(ranef_scores)[2] <- "ranef_int" # random intercepts
individual_effects <- coef(mod)$UID; individual_effects<- rownames_to_column(individual_effects, var="UID") # population adjusted BLUPs; global mean + ranef_int.
rough_summ <- reg_monit_survey_results_mat_GT %>% group_by(UID) %>% summarise (rgh_mean=mean(`Myrtle rust worst score`, na.rm=T))
summ <- left_join(rough_summ, ranef_scores); summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects, by="UID")
# Check
reg_prediction_gt_plantingexp_summ <- left_join(reg_monit_survey_results_mat_GT, individual_effects)
## Compare prediction against blup
# Site split
reg_prediction_gt_plantingexp_comp <- ggplot(reg_prediction_gt_plantingexp_summ, aes(x=Prediction, y=`(Intercept)`)) +
geom_point(alpha=0.1) +
geom_smooth(method = 'lm', colour="grey", linetype="dashed", se=F) +
theme_bw() +
labs (title = "Prediction vs BLUP") +
facet_wrap(~Site)
ggsave(reg_prediction_gt_plantingexp_comp, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/reg_prediction_gt_plantingexp_comp.jpg", width=3500, height=2000, units="px", limitsize=F)
## Difference from worst score rescaled to 0,3 vs predicted
reg_prediction_gt_plantingexp_summ$mrws_rescale <- scales::rescale(reg_prediction_gt_plantingexp_summ$`Myrtle rust worst score`, from = c(0,5), to=c(0,3))
reg_prediction_gt_plantingexp_summ$mrws_rescale_pred_diff <- reg_prediction_gt_plantingexp_summ$mrws_rescale - reg_prediction_gt_plantingexp_summ$Prediction
## Difference over time remade\
# Colour individuals with biggest departure
UID_means <- reg_prediction_gt_plantingexp_summ %>%
group_by(UID) %>%
summarise(mean_diff = mean(mrws_rescale_pred_diff, na.rm = TRUE))
prediction_survey_res_alt <- left_join(reg_prediction_gt_plantingexp_summ, UID_means, by = "UID")
colour_thresh=3
prediction_survey_res_alt$UID_highlight <- ifelse(abs(prediction_survey_res_alt$mean_diff) > colour_thresh, prediction_survey_res_alt$UID, "Other")
colours <- length(unique(prediction_survey_res_alt$UID_highlight)) - 1
## Need to look at 1) Most recent MR incidence, 2) Last and last 2 months of MR incidence
### Load in blups
height_byMR <- reg_prediction_gt_plantingexp_summ %>%
group_by(Site, UID_numb, `(Intercept)`) %>%
mutate(n = n()) %>%
filter(n > 2) %>%
group_by(Site, UID_numb) %>%
arrange(Date, .by_group = TRUE) %>%
summarise(Height_diff = (`Height (m)` - lag(`Height (m)`)),
Season = Season,
BLUP = (`(Intercept)`),
MR_impact_overall = mean(`Myrtle rust impact score`),
MR_date = lag(`Myrtle rust worst score`, n=0),
MR_last_date = lag(`Myrtle rust worst score`, n=1),
MR_last_2date = lag(`Myrtle rust worst score`, n=2),
MR_last_3date = lag(`Myrtle rust worst score`, n=3)) %>%
ungroup()
Height_x_MR_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_date, Height_diff, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_date, Height_diff, fill=BLUP, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_2date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_2date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_2date, Height_diff, fill=BLUP, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_3date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_3date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_3date, Height_diff, fill=BLUP, group=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_mean_imp <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_impact_overall, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_impact_overall, Height_diff, group=BLUP, fill=BLUP, colour=BLUP), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
plot_all_height_MRrecent <- Height_x_MR_date / Height_x_MR_last_date / Height_x_MR_last_2date / Height_x_MR_last_3date / Height_x_MR_mean_imp + theme(legend.position='none')
ggsave(plot_all_height_MRrecent, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_all_height_MRrecent.jpg", width=2000, height=4500, units="px", limitsize=F)
### Load in blups
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_3date + BLUP + (1|UID_numb))))
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_3date + BLUP + Summer + (1|UID_numb))))
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_3date + BLUP + Season + (1|UID_numb))))
summary(lmer(data = height_byMR, formula = (Height_diff ~ MR_last_date + BLUP + (1|Season) + (1|UID_numb))))
Height_x_MR_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_2date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_2date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_2date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_last_3date <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_last_3date, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_last_3date, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
Height_x_MR_mean_imp <- ggplot() +
geom_point(data = height_byMR, aes(x=MR_impact_overall, Height_diff, colour=BLUP), alpha = 0.5) +
facet_wrap(~Site) +
geom_smooth(method="lm", data = height_byMR, aes(x=MR_impact_overall, Height_diff), linewidth=0.5, alpha = 0.05) +
theme_bw() +
theme(legend.position='none')
plot_all_height_MRrecent <- Height_x_MR_date / Height_x_MR_last_date / Height_x_MR_last_2date / Height_x_MR_last_3date / Height_x_MR_mean_imp + theme(legend.position='none')
ggsave(plot_all_height_MRrecent, file="~/Uni/Doctorate/Ch Planting/Publication/Plots/plot_all_height_MRrecent.jpg", width=2000, height=4500, units="px", limitsize=F)
shiny::runApp('Uni/Doctorate/Samples/Seedlot_plot_data/Seedlot_plot_ShinyMap')
runApp('Uni/Doctorate/Samples/Seedlot_plot_data/Seedlot_plot_ShinyMap')
